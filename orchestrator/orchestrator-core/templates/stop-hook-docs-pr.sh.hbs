#!/bin/bash
# Post-completion hook for docs generation
# Commits and pushes documentation changes to feature branch

set -e

echo "üîó Post-completion hook: Committing and pushing documentation changes..."

# Get current working directory
WORKING_DIR="$(pwd)"
echo "Working directory: $WORKING_DIR"

# Ensure we're in a git repository
if [ ! -d ".git" ]; then
    echo "‚ùå Error: Not in a git repository"
    exit 1
fi

# Source GitHub environment if available
if [ -f ".github-env" ]; then
    source .github-env
    echo "‚úÖ Loaded GitHub environment"
else
    echo "‚ö†Ô∏è  Warning: .github-env not found"
fi

# Configure git user (use PM user or repository user)
PM_USER="{{repository.githubUser}}"
if [ -n "$PM_USER" ]; then
    git config user.name "$PM_USER"
    git config user.email "${PM_USER}@users.noreply.github.com"
    echo "‚úÖ Configured git user: $PM_USER"
else
    echo "‚ö†Ô∏è  Warning: No PM user configured"
fi

# Check if there are changes to commit
if git diff --quiet && git diff --cached --quiet; then
    echo "‚ÑπÔ∏è  No changes to commit"
    exit 0
fi

# Stage all changes
echo "üìù Staging changes..."
git add .

# Create commit message
COMMIT_MSG="docs: auto-generate Task Master documentation

- Generated documentation for Task Master tasks
- Updated by Claude Code agent
- Working directory: $WORKING_DIR

ü§ñ Generated by Claude Code - Docs Generation"

# Commit changes
echo "üíæ Committing changes..."
git commit -m "$COMMIT_MSG"

# Push to current branch
CURRENT_BRANCH=$(git branch --show-current)
echo "üöÄ Pushing to branch: $CURRENT_BRANCH"

if [ -n "$GITHUB_TOKEN" ]; then
    # Use token for authentication
    git push origin "$CURRENT_BRANCH"
    echo "‚úÖ Successfully pushed to $CURRENT_BRANCH"

    # Create PR if we're not on the main branch
    if [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "master" ]; then
        echo "üîÄ Creating pull request..."

        PR_TITLE="docs: auto-generate Task Master documentation"
        PR_BODY="## Documentation Update

**Generated by:** Claude Code Agent
**Working Directory:** \`$WORKING_DIR\`
**Branch:** \`$CURRENT_BRANCH\`
**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

### Changes
- Auto-generated Task Master documentation
- Updated task files and specifications

### Notes
This PR was automatically created by the Claude Code documentation generation system.

ü§ñ **Auto-generated** - Review and merge when ready"

        # Create PR using GitHub CLI
        if command -v gh >/dev/null 2>&1; then
            gh pr create \
                --title "$PR_TITLE" \
                --body "$PR_BODY" \
                --base main \
                --head "$CURRENT_BRANCH" \
                || echo "‚ö†Ô∏è  PR creation failed (may already exist)"
            echo "‚úÖ Pull request created successfully"
        else
            echo "‚ö†Ô∏è  GitHub CLI not available - skipping PR creation"
        fi
    else
        echo "‚ÑπÔ∏è  On main branch - no PR needed"
    fi
else
    echo "‚ùå Error: No GitHub token available for push"
    exit 1
fi

echo "üéâ Documentation commit and push completed successfully!"