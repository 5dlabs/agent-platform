#!/bin/sh

echo '════════════════════════════════════════════════════════════════'
echo '║                    CLAUDE AGENT STARTING                     ║'
echo '════════════════════════════════════════════════════════════════'

# Source GitHub environment if it exists
if [ -f /workspace/.github-env ]; then
  . /workspace/.github-env
  echo "✓ GitHub authentication configured"
  
  # Configure git credentials for HTTPS authentication
  if [ -n "$GITHUB_TOKEN" ] && [ -n "$GITHUB_USER" ]; then
    git config --global user.name "$GITHUB_USER"
    git config --global user.email "${GITHUB_USER}@users.noreply.github.com"
    
    # Ensure git credentials file exists with correct format
    echo "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com" > /workspace/.git-credentials
    chmod 600 /workspace/.git-credentials
    
    # Configure git to use the credentials
    git config --global credential.helper 'store --file=/workspace/.git-credentials'
    
    # Also configure the repository-specific credential helper
    cd /workspace && git config credential.helper 'store --file=/workspace/.git-credentials'
    
    echo "✓ Git credentials configured for user: $GITHUB_USER"
    echo "✓ Git push should now work with HTTPS"
  fi
fi

# Export script should already be created by prep job

echo '=== WORKSPACE VALIDATION ==='

# Validate that prep job completed successfully
MISSING_FILES=""
REQUIRED_FILES="CLAUDE.md task.md design-spec.md prompt.md acceptance-criteria.md .claude.json"

echo "Checking for required files..."
for file in $REQUIRED_FILES; do
  if [ ! -f "/workspace/$file" ]; then
    echo "ERROR: Missing required file: $file"
    MISSING_FILES="$MISSING_FILES $file"
  else
    echo "✓ Found: $file"
  fi
done

# Check for git repository (optional - only needed for tasks that push code)
if [ ! -d "/workspace/.git" ]; then
  echo "! Note: No git repository found (okay for non-code tasks)"
else
  echo "✓ Found: git repository"
fi

# If any files are missing, abort
if [ -n "$MISSING_FILES" ]; then
  echo ""
  echo "═══════════════════════════════════════════════════════════════"
  echo "║                 WORKSPACE VALIDATION FAILED                  ║"
  echo "═══════════════════════════════════════════════════════════════"
  echo ""
  echo "The following required files/directories are missing:"
  echo "$MISSING_FILES"
  echo ""
  echo "This indicates the prep job didn't complete successfully."
  echo "Claude will NOT be started to avoid wasting API credits."
  echo ""
  exit 1
fi

echo ""
echo "✓ All required files present. Workspace is valid."
echo ""

echo '=== MARKDOWN FILES PROVIDED ==='
echo "The following documentation files are available to Claude:"
echo ""
# List all markdown files with their sizes
find /workspace -maxdepth 1 -name "*.md" -type f | sort | while read -r file; do
  filename=$(basename "$file")
  size=$(wc -c < "$file" | xargs)
  echo "📄 $filename ($size bytes)"
done
echo ""

# Debug mode - show file contents if DEBUG_SHOW_FILES is set
if [ "$DEBUG_SHOW_FILES" = "true" ]; then
  echo '=== DEBUG: FILE CONTENTS ==='
  echo "Showing contents of all markdown files:"
  echo ""
  
  find /workspace -maxdepth 1 -name "*.md" -type f | sort | while read -r file; do
    filename=$(basename "$file")
    echo "════════════════════════════════════════════════════════════════"
    echo "║ FILE: $filename"
    echo "════════════════════════════════════════════════════════════════"
    cat "$file"
    echo ""
    echo ""
  done
  
  echo "════════════════════════════════════════════════════════════════"
  echo "║ END OF FILE CONTENTS"
  echo "════════════════════════════════════════════════════════════════"
  echo ""
fi

# Check if prompt.md exists (should always exist from prep job)
if [ ! -f /workspace/prompt.md ]; then
  echo 'ERROR: prompt.md not found - prep job may have failed'
  exit 1
fi

echo '=== STARTING CLAUDE ==='

# Build Claude command with print mode, streaming output, and explicit tools
CLAUDE_CMD="{{command}} -p --output-format stream-json --verbose --allowedTools Bash,Edit,Read,Write,Glob,Grep,LS,MultiEdit,WebSearch,WebFetch,TodoRead,TodoWrite"

{{#if model_override}}
CLAUDE_CMD="$CLAUDE_CMD --model={{model}}"
{{/if}}

{{#if is_retry}}
CLAUDE_CMD="$CLAUDE_CMD --continue"
echo 'Adding --continue flag for attempt {{attempts}}'
{{/if}}

# Use stdin to pass the prompt content
echo "Final Claude command: $CLAUDE_CMD (with prompt from stdin)"
exec $CLAUDE_CMD < /workspace/prompt.md