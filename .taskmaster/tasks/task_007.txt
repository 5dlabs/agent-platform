# Task ID: 7
# Title: Implement TaskRun CRD for Job Management
# Status: done
# Dependencies: None
# Priority: critical
# Description: Replace Helm-based Job management with custom Kubernetes CRD
# Details:
Create TaskRun CRD to manage Jobs with dynamic context updates. Includes enhanced status subresource, job monitoring, validation, and kube-runtime controller for production-grade reliability.

# Test Strategy:


# Subtasks:
## 1. Define Enhanced TaskRun CRD Schema [done]
### Dependencies: None
### Description: Create CRD YAML with status subresource and validation
### Details:
Define spec (taskId, serviceName, contextVersion, markdownFiles) and status subresource with phase, jobName, message, lastUpdated fields. Enable status subresource for proper Kubernetes patterns.

## 2. Add Kube-rs Dependencies with Runtime [done]
### Dependencies: None
### Description: Add Kubernetes controller runtime dependencies
### Details:
Add kube, kube-runtime, kube-derive, k8s-openapi, futures, and tokio dependencies to orchestrator-core/Cargo.toml

## 3. Implement TaskRun Types with Status [done]
### Dependencies: 7.1, 7.2
### Description: Create Rust structs for TaskRun CRD with status
### Details:
Use kube-derive CustomResource macro with status subresource. Include TaskRunSpec and TaskRunStatus structs.

## 4. Create Production TaskRun Controller [done]
### Dependencies: 7.3
### Description: Implement controller with kube-runtime framework
### Details:
Use Controller::new with exponential backoff, finalizers for cleanup, proper error handling. Monitor Job status and update TaskRun accordingly.

## 5. Update PM Handler with Validation [done]
### Dependencies: 7.4
### Description: Replace Helm with TaskRun creation and validation
### Details:
Check for existing TaskRun before creating, validate markdown files not empty, create TaskRun with proper labels and status.

## 6. Add Context Update with Server-Side Apply [done]
### Dependencies: 7.5
### Description: Implement conflict-free context updates
### Details:
Use Server-Side Apply for updating TaskRun with new context. Increment version and append markdown files.

## 7. Implement Job Status Monitoring [done]
### Dependencies: 7.4
### Description: Track Job completion and update TaskRun status
### Details:
In reconciliation loop, check Job status and update TaskRun phase to Running/Succeeded/Failed with appropriate messages.

## 8. Create Migration Script [done]
### Dependencies: 7.6, 7.7
### Description: Script to migrate existing Helm releases to TaskRuns
### Details:
List existing releases, extract task data, create equivalent TaskRuns, verify migration

