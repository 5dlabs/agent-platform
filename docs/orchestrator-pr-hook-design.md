# Post-Completion PR Creation Hook Design

## Overview
Instead of relying on Claude to create PRs, implement a post-completion hook in the TaskRun controller that automatically creates PRs for documentation generation tasks.

## Implementation Approach

### 1. Detect Task Completion
In the TaskRun controller, when a documentation task (task_id = 999999) completes successfully:

```rust
// In taskrun_controller.rs
if tr.spec.task_id == 999999 && job_status == "Succeeded" {
    // Trigger PR creation
    create_documentation_pr(&tr, &main_job).await?;
}
```

### 2. PR Creation Function
```rust
async fn create_documentation_pr(
    tr: &TaskRun,
    job: &Job,
) -> Result<()> {
    // Extract branch info from job logs or TaskRun spec
    let source_branch = tr.spec.repository.as_ref()?.branch.clone();
    
    // Get the documentation branch name from prep job
    let doc_branch = get_doc_branch_from_job(job).await?;
    
    // Create a new Kubernetes Job for PR creation
    let pr_job = create_pr_job(tr, &doc_branch, &source_branch)?;
    
    // Submit the job
    let job_api: Api<Job> = Api::namespaced(client, &namespace);
    job_api.create(&PostParams::default(), &pr_job).await?;
    
    Ok(())
}
```

### 3. PR Creation Job Template
Create a lightweight job that:
- Uses the GitHub CLI container
- Mounts the same workspace volume
- Has proper GitHub authentication
- Creates the PR

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: pr-creator-{{ taskrun_name }}
spec:
  template:
    spec:
      containers:
      - name: pr-creator
        image: ghcr.io/cli/cli:latest
        command:
        - sh
        - -c
        - |
          cd /workspace
          gh pr create \
            --title "docs: auto-generate Task Master documentation" \
            --body "$(cat <<'EOF'
          ## ðŸ“š Auto-Generated Task Master Documentation
          
          This PR contains automatically generated documentation for Task Master tasks.
          
          ### ðŸ“‹ Documentation Generated:
          - Comprehensive task overviews (task.md)
          - Autonomous AI prompts (prompt.md)
          - Technical design specifications (design-spec.md)
          - Acceptance criteria (acceptance-criteria.md)
          
          ### ðŸ¤– Generated by
          - Model: {{ model }}
          - Task: {{ task_id }}
          - Timestamp: {{ timestamp }}
          
          ---
          _Automatically generated by Orchestrator Documentation Service_
          EOF
          )"
        env:
        - name: GH_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-pat-{{ github_user }}
              key: token
        volumeMounts:
        - name: workspace
          mountPath: /workspace
```

## Alternative: Sidecar Container Approach

Instead of a separate job, use a sidecar container that monitors for completion:

```yaml
containers:
- name: claude-agent
  # ... existing Claude container ...
  
- name: pr-monitor
  image: custom-pr-creator:latest
  command:
  - /bin/monitor-and-create-pr
  env:
  - name: WATCH_PATH
    value: /workspace/.taskmaster/docs
  - name: SIGNAL_FILE
    value: /workspace/.docs-complete
  volumeMounts:
  - name: workspace
    mountPath: /workspace
```

## Benefits Over In-Prompt PR Creation:

1. **Reliable Authentication**: Can use proper GitHub tokens without exposing to Claude
2. **Retry Logic**: Can implement exponential backoff for transient failures
3. **Consistent PR Format**: Always creates PRs with the same structure
4. **Error Recovery**: Can handle push conflicts, branch protection rules, etc.
5. **Audit Trail**: Separate job/container for PR creation provides clear audit log
6. **No AI Confusion**: Claude focuses only on documentation generation

## Configuration Options:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: docs-pr-config
data:
  pr_title_template: "docs: auto-generate Task Master documentation for {{ task_info }}"
  pr_body_template: |
    ## Documentation Update
    Generated by: {{ agent_name }}
    Model: {{ model }}
    Tasks documented: {{ task_count }}
  auto_merge: "false"
  reviewers: "team-leads"
  labels: "documentation,auto-generated"
```

## Implementation Priority:
1. Start with simple post-completion job approach
2. Add retry logic and error handling
3. Consider sidecar approach if needed for real-time monitoring
4. Add configuration options for customization